<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>LinPack System</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="./js/ui-interactions.js"></script> 
  <script src="./js/graph-render.js"></script>
  <script src="./js/process-data-from-sparql.js"></script>
  <script src="./js/bubble-chart-render.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    svg { width: 100vw; height: 100vh; }
    .node circle { stroke: #fff; stroke-width: 1.5px; }
    .node text { pointer-events: none; font-size: 12px; }
    line { stroke: #999; stroke-opacity: 0.6; }
  </style>
</head>
<body>
  <div id="tooltip" style="
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px;
    border-radius: 6px;
    pointer-events: none;
    font-size: 12px;
    display: none;
  "></div>
  <div style="position: fixed; top: 10px; left: 10px; background: #eee; padding: 8px; border-radius: 6px; z-index: 10;">
  <label for="viewSelect">Visualização: </label>
  <select id="viewSelect">
    <option value="graph">Grafo</option>
    <option value="bubble">Bubble Chart</option>
  </select>
</div>


  <svg></svg>

  <script>
 
async function main() {
  try {
    const [logData, cveData, rawData] = await Promise.all([
      fetchDataFromSPARQLEndPoint(queryLog),
      fetchDataFromSPARQLEndPoint(queryCVE),
      fetchDataFromSPARQLEndPoint(countCVEsPerProductQuery)
    ]);

    const logGraph = processLogDataToGraph(logData);
    const cveGraph = processCVEDataToGraph(cveData);
    const { nodes, links } = mergeGraphs(logGraph, cveGraph);

    const processedData = processCountData(rawData);

    renderGraph(nodes, links);

    d3.select("#viewSelect").on("change", (event) => {
      const view = event.target.value;
      const svg = d3.select("svg");
      
      // Resetar zoom antes de limpar e redesenhar
      svg.call(d3.zoom().transform, d3.zoomIdentity);
      
      svg.selectAll("*").remove();

      if (view === "graph") {
        renderGraph(nodes, links);
      } else if (view === "bubble") {
        renderBubbleChart(processedData);
      }
    });

  } catch (err) {
    console.error("Erro ao carregar e processar dados:", err);
  }
}

main();

  </script>
</body>
</html>
